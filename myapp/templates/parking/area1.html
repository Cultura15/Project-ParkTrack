<!DOCTYPE html>
{% extends 'base.html' %}
{% load static %}

{% block title %}NGE Area - ParkTrack{% endblock %}

{% block content %}

<header>
    NGE. <span>PARKING AREA</span>
</header>



<div class="container1">
    <div class="legends1">
        <h3>Legends</h3>
        <div class="legend-item">
            <div style="background-color: red;"></div>
            <span>Occupied</span>
        </div>
        <div class="legend-item">
            <div style="background-color: greenyellow;"></div>
            <span>Vacant</span>
        </div>
        <div class="legend-item">
            <div style="background-color: #ffd700;"></div>
            <span>Your Vehicle</span>
        </div>
    </div>

    <div class="status1">
        <h3>Your Current Status</h3>
        <p id="vehicle-status" class="not-parked">Vehicle Not Parked</p>
    </div>
</div>

<div id="parking-lot-container"></div>


<script>

  document.addEventListener('DOMContentLoaded', () => {
    const areaId = 1; 
    const userId = parseInt("{{ user.id }}"); // Ensure userId is an integer
    const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const wsUrl = `${wsProtocol}${window.location.host}/ws/reservation/${areaId}/`;
    const ws = new WebSocket(wsUrl);

    // WebSocket onclose event
    ws.onclose = function () {
        console.error("WebSocket connection closed unexpectedly");
    };

    // Function to fetch parking lots and render them
    function fetchParkingLots() {
        const url = `http://127.0.0.1:8000/api/get-parking-lots/${areaId}/`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('parking-lot-container');
                container.innerHTML = ""; // Clear existing content

                data.parking_lots.forEach((lot, index) => {
                    const lotDiv = document.createElement('div');
                    lotDiv.classList.add('lot');
                    lotDiv.classList.add(lot.status.toLowerCase());
                    lotDiv.id = `lot-${lot.id}`;

                    // Position logic for parking lots
                    const columns = 2;
                    const rows = 5;
                    const columnIndex = index < rows ? 0 : 1;
                    const rowIndex = index % rows;
                    const position_x = columnIndex * 1000 + 250;
                    const position_y = rowIndex * 145 + 108;

                    lotDiv.style.top = `${position_y}px`;
                    lotDiv.style.left = `${position_x}px`;

                    // Lot details
                    const lotNumber = document.createElement('p');
                    lotNumber.innerText = `Lot ${lot.parking_lot_number}`;
                    const lotStatus = document.createElement('p');
                    lotStatus.innerText = lot.status;
                    lotStatus.id = `status-${lot.id}`;

                    // Add circle button for available lots
                    if (lot.status.toLowerCase() === "available") {
                        const button = document.createElement('button');
                        button.classList.add('circle-button');
                        button.style.top = `${position_y + 40}px`;
                        button.style.left = `${position_x + (columnIndex === 0 ? 240 : -170)}px`;
                        button.dataset.lotId = lot.id;
                        button.dataset.isParked = "false";

                        // Add click event listener to the button
                        button.addEventListener('click', (e) => toggleParkingStatus(e, lot.parking_lot_number));
                        container.appendChild(button);
                    }

                    lotDiv.appendChild(lotNumber);
                    lotDiv.appendChild(lotStatus);
                    container.appendChild(lotDiv);
                });
            })
            .catch(error => {
                console.error('Error fetching parking lots:', error);
            });
    }

    // Function to toggle parking status
    function toggleParkingStatus(event, lotNumber) {
        const button = event.target;
        const lotId = button.dataset.lotId;

        const action = button.dataset.isParked === "true" ? "release" : "reserve";
        const payload = {
            action: action,
            lot_id: lotId,
            lot_number: lotNumber,
            user: userId,
            entry_date: new Date().toISOString().split('T')[0],
            entry_time: new Date().toLocaleTimeString(),
            exit_date: "", // Placeholder, implement logic as needed
            exit_time: ""
        };

        console.log("Sending payload:", payload); // Debugging
        ws.send(JSON.stringify(payload));
    }

    // Fetch and render parking lots on page load
    fetchParkingLots();
});
</script>



<style>

    header {
            color: #800000; /* Maroon color for "NGE" */
            padding: 20px;
            text-align: center;
            font-size: 35px;
            font-weight: bold;
            letter-spacing: 1px;
        
        }
        
    header span {
            color: #FFD700; /* Yellow color for "Parking Area" */
        }
   
   
    .container1 {
        display: flex;
        justify-content: space-between;
        padding: 20px;
        gap: 100px;
    }
    .legends1, .status1 {
        width: 300px;
        height: 150px;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        background-color: lightgray;
        
    }
    .legends1 h3, .status1 h3 {
        margin-top: 5px;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    .legend-item div {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border-radius: 50%; 
        border: solid black 2px;
    }
    .legend-item span {
        font-size: 16px;
    }
    .status1 p {
        font-size: 18px;
        font-weight: bold;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
    }
    .status1 .parked {
        color: green;
    }
    .status1 .not-parked {
        color: red;
    }
    /* area map size */
    #parking-lot-container {
        position: relative;
        background-image: url('{% static "NGE.png" %}');
        background-size: 100% 80%;
        background-repeat: no-repeat;
        background-position: center;
        width: 1600px;
        height: 900px;
        margin: 0 auto;
        overflow: hidden;
    }

    /* adjust the container sizes of parkinglots */
    .lot {
        position: absolute;
        width: 150px;
        height: 100px;
        border: 1px solid #000;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 5px;
        text-align: center;
        font-size: 12px;
        background-color: lightgreen; /* Default for available */
        z-index: 10;
    }
    .available {
        background-color: greenyellow; /* Green for available */
    }
    .occupied {
        background-color: red; /* Red for reserved */
    }
    .your-vehicle {
        background-color: #ffd700; /* Yellow for your vehicle */
    }
    .circle-button {
        position: absolute;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background-color: rgb(170, 255, 0);
        border: solid black 2px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        border: none;
        cursor: pointer;
        z-index: 20;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    .circle-button:hover {
        background-color: #FFD700;
    }
</style>

{% endblock %}